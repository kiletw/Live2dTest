<html>
<head>
	<meta charset="UTF-8">
	<title>WebGL x Live2D for cross-platform browser app!</title>
	</meta>
	<meta name="viewport" content="width=device-width; initial-scale=1.0; maximum-scale=1.0; user-scalable=no;"/>
	<meta name="apple-mobile-web-app-capable" content="yes"/>
	<link href="css/main.css" rel="stylesheet" type="text/css">
</head>
<body onload="main()">

    <div id="canvas_box" width="640">
	
	    <img 	id="loading" src="res/loading.gif">
		
		<img 	id="back_img" 	width="640" height="800" src="res/back/back_MF003_blur.jpg" >
		<canvas id="glcanvas" 	width="640" height="800" ></canvas>
		
		<div id="dummy_box"></div>
		<input type="button" value="SaveImage" onclick="capchImage()">
	</div>
     <div id="pngHolder" width="640">
	</div>
</div>

<!-- ###### SCRIPT ###### -->
<script>
window.PROMO_MODEL_SETTING = {
	MODEL_JSON_PATH : "res/izumi_suisai/izumi_suisai.model.json" ,
	ZOOM : 1.5 ,
	ZOOM_CENTER_X : 0 ,
	ZOOM_CENTER_Y : 0.6 ,
	OFFSET_X : 0 ,
	OFFSET_Y : -0.1 ,
} ;
</script>

<script src="lib/live2d.min.js"></script>
<script src="lib/live2d_framework.js"></script>
<script src="lib/promo1_util.js"></script>
<script src="lib/sample_wrapper.js"></script>

<script src="lib/promo1.js"></script>
<script type="text/javascript" src="lib/LZWEncoder.js"></script>
<script type="text/javascript" src="lib/NeuQuant.js"></script>
<script type="text/javascript" src="lib/GIFEncoder.js"></script>
<script type="text/javascript" src="lib/b64.js"></script>
<script>
    var count = 0;
    var encoder = new GIFEncoder();
    function capchImage(){
	    encoder = new GIFEncoder();
	
		count = 0;
	   	canvas = document.getElementById("glcanvas");
		var context = canvas.getContext('2d');
		
		 encoder.setRepeat(0);
		 encoder.setDelay(33.33);
		 encoder.start();
		 	 encoder.addFrame(context);
		
		
	   setTimeout(capchImage2,33.33);
	}
     
  function capchImage2(){
	 encoder.addFrame(context);
	count++;
	if(count < 90){
		setTimeout(capchImage2,33.33);
	}
	else{
	document.getElementById("pngHolder").appendChild(convertCanvasToImage(canvas));
	}
  }
	
	
	function convertCanvasToImage(canvas) {
				encoder.finish();
				var image = new Image();
				 var binary_gif = encoder.stream().getData();
				var data_url = 'data:image/gif;base64,'+encode64(binary_gif);
				image.src = data_url;
				return image;
			}

</script>

</body>
</html>